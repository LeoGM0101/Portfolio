---
title: "Atividade de Análise Multivariada"
author: "Leonardo Gomes Malaquias"
date: "2023-12-08"
output:
  html_document: default
  word_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Exercicio 6.1: Dados de volume de árvores

Os dados referem-se a medidas de diametro a 4,5 pes acima do solo (D, polegadas) e altura (H, pes) de 21 cerejeiras (“black cherry”) em pe e de volume (V , pes cubicos) de arvores derrubadas (Ryan et al., 1976). O objetivo desse tipo de experimento e verificar de que forma essas variaveis estao relacionadas para, atraves de medidas nas arvores em pe, poder predizer o volume de madeira em uma area de floresta (Allegheny National Forest).

```{r Exercicio 6.1.1, echo=T, message=FALSE, warning=FALSE}
rm(list=ls())
library(readxl)
library(tidyverse)
library(tidyr)
library(moments)
library(MASS)
library(car)
library(corrplot)
library(EnvStats)

data(trees, package="datasets")
attach(trees)

#------------------------------------------------------------------------------#
#Analise Exploratoria dos dados
dados_longos = tidyr::pivot_longer(trees, cols = c(Girth, Height, Volume), names_to = "Variavel", values_to = "Valor")

estatisticas_descritivas = dados_longos %>%
  group_by(Variavel) %>%
  summarise(Media = mean(Valor),
            Mediana = median(Valor),
            Desvio_Padrao = sd(Valor),
            `IQR` = IQR(Valor),
            Curtose = kurtosis(Valor),
            Simetria = skewness(Valor),
            Minimo = min(Valor),
            Maximo = max(Valor),
            outliers_inferiores = sum(Valor < quantile(Valor, 0.25) - 1.5 * IQR(Valor)),
            outliers_superiores = sum(Valor > quantile(Valor, 0.75) + 1.5 * IQR(Valor))); estatisticas_descritivas

corrplot(cor(trees), method = "number")


#teste de normalidade
dados_longos %>%
  group_by(Variavel) %>%
  summarise(valor_p = shapiro.test(Valor)$p.value)

ggplot(dados_longos, aes(x = Valor)) +
  geom_histogram(color = "black", fill = "lightblue") +
  facet_wrap(~ Variavel, scales = "free") +
  labs(x = "Valores", y = "Frequencias", title = "Histogramas das Variaveis") +
  theme_minimal()

ggplot(dados_longos, aes(x = Variavel, y = Valor)) +
  geom_boxplot() +
  facet_wrap(~ Variavel, scales = "free") +
  labs(x = "Valores", y = "Frequencias", title = "Boxplots das Variaveis") +
  theme_minimal()

ggplot(dados_longos, aes(x = Variavel, color = Variavel)) +
  geom_density() +
  labs(y = "Densidade", title = "Grafico de Densidade das Variaveis") +
  theme_minimal() +
  theme(axis.text.x = element_blank())

```

  Em relação as estatísticas descritivas da variável Girth (circunferência), podemos afirmar que a mediana, que representa o valor do meio, é  de 12.9. A amplitude interquartil indica que 50% dos dados estão dentro de uma faixa de 4.2 unidades. A curtose de 2.44 indica uma distribuição leptocúrtica, enquanto que a simetria positiva de 0.53 indica que a cauda direita é um pouco mais longa.A circunferência varia de 8.3, que é o valor mínimo, a 20.6 unidades, que é o valor máximo. Essa variável não apresenta outliers.
  Já em relação as estísticas descritivas da variável Height (altura) mostram que a média da altura das árvores, de 76 unidades, coincide com o valor da mediana. O desvio padrão de 6.37 sugere uma baixa dispersão dos dados em torno da média. O intervalo interquartil de 8.0 indica que boa parte dos dados está concentrada nessa faixa. A curtose de 2.43 indica uma distribuição leptocúrtica, enquanto que a simetria negativa de -0.37 indica uma cauda esquerda ligeiramente mais longa. A altura varia de 63.0 a 87.0 unidades. Não há outliers.
  As estatísticas descritivas da variável Volume apresenta uma média de 30.17 unidades e um desvio padrão de 16.44, o que indica uma alta dispersão dos dados. A mediana é 24.2, indicando uma distribuição assimétrica positiva. A curtose de 3.47 indica uma distribuição leptocúrtica, enquanto que a simetria positiva de 1.06 sugere uma cauda direita mais longa. O volume varia de 10.2 a 77.0 e nessa variável há um outlier.
  Foi feito o teste shapiro-wilk de normalidade e apenas a variável volume rejeitou a hipótese de normalidade à um nível de significância de 5%.
  Com relação ao gráfico de correlação, podemos notar que as variáveis da circunferência e do volume apresentam uma correlação positiva muito forte, enquanto que a correlação entre volume e altura e altura e circunferência é moderada.


```{r Exercicio 6.1.2, echo=T, message=FALSE, warning=FALSE}
## Fitted models ##
D = trees[,1]
H = trees[,2]
V = trees[,3]
mod1<-lm(V~1)
mod2<-lm(V~D)
summary(mod2)

mod3<-lm(V~H)
summary(mod3)

mod4<-lm(V~D+H)
summary(mod4)

anova(mod1, mod4)
anova(mod1, mod2, mod4)
anova(mod1, mod3, mod4)


```
  
  O primeiro modelo (mod2) apresenta função de ligação identidade e segundo o teste realizado, a um nível de significância de 1%, podemos dizer que existe evidências estatísticas suficientes para dizer que o efeito do diâmetro é significativo para o volume da árvore.
  O efeito aaltura também é relevante para explicar o volume da árvore, contudo, ao analisarmos ambos, podemos dizer que o diâmetro é mais significativo para o volume do que a altura.
  

```{r Exercicio 6.1.3, echo=T, message=FALSE, warning=FALSE}
#################################################
# A set of four plots for diagnostics #
#################################################
n<-dim(trees)[1] # number of data
par(mfrow=c(2,2))

# Observed against fitted values #
plot(fitted(mod4),V)
identify(fitted(mod4),V) #click on the point, use ESC in R to esc

# abs(DFFitS) vs index #
plot(abs(dffits(mod4)))
abline(3*sqrt(mod4$rank/mod4$df.residual),0,lty=2)
identify(1:n,abs(dffits(mod4))) #click on the point, use ESC in R to esc Modelos Lineares Generalizados 347

# QQplot with a simulated envelope #
fit.model <- mod4

par(mfrow=c(1,1))
X <- model.matrix(fit.model)
n <- nrow(X)
p <- ncol(X)
H <- X%*%solve(t(X)%*%X)%*%t(X)
h <- diag(H)
si <- lm.influence(fit.model)$sigma
r <- resid(fit.model)
tsi <- r/(si*sqrt(1-h))
#
ident <- diag(n)
epsilon <- matrix(0,n,100)
e <- matrix(0,n,100)
e1 <- numeric(n)
e2 <- numeric(n)
#
for(i in 1:100){
     epsilon[,i] <- rnorm(n,0,1)
     e[,i] <- (ident - H)%*%epsilon[,i]
     u <- diag(ident - H)
     e[,i] <- e[,i]/sqrt(u)
     e[,i] <- sort(e[,i]) }
#
for(i in 1:n){
     eo <- sort(e[i,])
     e1[i] <- (eo[2]+eo[3])/2
     e2[i] <- (eo[97]+eo[98])/2 }
#
med <- apply(e,1,mean)
faixa <- range(tsi,e1,e2)
#
par(pty="s")
qqnorm(tsi,xlab="Percentil da N(0,1)",
ylab="Residuo Studentizado", ylim=faixa, pch=16, main="")
par(new=TRUE)
qqnorm(e1,axes=F,xlab="",ylab="",type="l",ylim=faixa,lty=1, main="")
par(new=TRUE)
qqnorm(e2,axes=F,xlab="",ylab="", type="l",ylim=faixa,lty=1, main="")
par(new=TRUE)
qqnorm(med,axes=F,xlab="",ylab="",type="l",ylim=faixa,lty=2, main="")

```

  O gráfico dos valores observador e ajustados indica que há uma certa tendência linear e o gráfico do envelope simulado indica um bom ajuste do modelo, visto que nenhum ponto ficou de fora dos limites. 


```{r Exercicio 6.1.4, echo=T, message=FALSE, warning=FALSE}

##################################################
## Log transformed data ##
#Scatterplots
D = trees[,1]
H = trees[,2]
V = trees[,3]
logD<-log(D)
logH<-log(H)
logV<-log(V)
ltrees<-cbind(logD,logH,logV)
pairs(ltrees)

## Fitted models ##
mod1<-lm(logV~1)
mod2<-lm(logV~logD)
summary(mod2)

mod3<-lm(logV~logH)
summary(mod3)

mod4<-lm(logV~logD+logH)
summary(mod4)

anova(mod1, mod4)
anova(mod1, mod2, mod4)
anova(mod1, mod3, mod4)
```

  Com os dados transformados, podemos perceber também que o efeito do diâmetro é mais significativo para o volume do que o efeito da altura.


```{r Exercicio 6.1.5, echo=T, message=FALSE, warning=FALSE}
#################################################
# A set of four plots for diagnostics #
#################################################
n<-dim(trees)[1] # number of data 348 Gauss M. Cordeiro & Clarice G.B. Dem´etrio
par(mfrow=c(2,2))

# Observed against fitted values #
plot(fitted(mod4),V)
identify(fitted(mod4),V)

# abs(DFFitS) vs index #
plot(abs(dffits(mod4)))
abline(3*sqrt(mod4$rank/mod4$df.residual),0,lty=2)
identify(1:n,abs(dffits(mod4)))

# QQplot with simulated envelope #
fit.model <- mod4

par(mfrow=c(1,1))
X <- model.matrix(fit.model)
n <- nrow(X)
p <- ncol(X)
H <- X%*%solve(t(X)%*%X)%*%t(X)
h <- diag(H)
si <- lm.influence(fit.model)$sigma
r <- resid(fit.model)
tsi <- r/(si*sqrt(1-h))
#
ident <- diag(n)
epsilon <- matrix(0,n,100)
e <- matrix(0,n,100)
e1 <- numeric(n)
e2 <- numeric(n)
#
for(i in 1:100){
     epsilon[,i] <- rnorm(n,0,1)
     e[,i] <- (ident - H)%*%epsilon[,i]
     u <- diag(ident - H)
     e[,i] <- e[,i]/sqrt(u)
     e[,i] <- sort(e[,i]) }
#
for(i in 1:n){
     eo <- sort(e[i,])
     e1[i] <- (eo[2]+eo[3])/2
     e2[i] <- (eo[97]+eo[98])/2 }
#
med <- apply(e,1,mean)
faixa <- range(tsi,e1,e2)
#
par(pty="s")
qqnorm(tsi,xlab="Percentil da N(0,1)",
ylab="Residuo Studentizado", ylim=faixa, pch=16, main="")
par(new=TRUE)
qqnorm(e1,axes=F,xlab="",ylab="",type="l",ylim=faixa,lty=1, main="")
par(new=TRUE)
qqnorm(e2,axes=F,xlab="",ylab="", type="l",ylim=faixa,lty=1, main="")
par(new=TRUE)
qqnorm(med,axes=F,xlab="",ylab="",type="l",ylim=faixa,lty=2, main="")

# Likelihood profile plot for Box-Cox #
boxcox(mod4)
```

  Podemos perceber que os valores ajustados e os valores observados apresentam uma tendência linear. O gráfico do envelope simulado também indica que os modelos podem ser um bom ajusta para os dados, visto que nenhum ponto ficou de fora dos limites. Entretanto, não podemos afirmar que o modelo transformado é melhor que o modelo não transformado, ou vice-versa, pois para isso será necessário realizar a análise de diagnóstico para cada modelo. 





Exercicio 6.2: Dados de gordura no leite
A Tabela 6.3 refere-se a producoes medias diarias de gordura (kg/dia) no leite de
uma unica vaca durante 35 semanas (McCulloch, 2001).


```{r Exercicio 6.2.1, echo=T, message=FALSE, warning=FALSE}
rm(list=ls())
library(readxl)
library(tidyverse)
library(tidyr)
library(moments)
library(MASS)
library(car)
library(corrplot)
library(EnvStats)


fatyield.dat <- data.frame('yield'=c(0.31, 0.39, 0.50, 0.58, 0.59, 0.64,
                                     0.68, 0.66, 0.67, 0.70, 0.72, 0.68,
                                     0.65, 0.64, 0.57, 0.48, 0.46, 0.45,
                                     0.31, 0.33, 0.36, 0.30, 0.26, 0.34,
                                     0.29, 0.31, 0.29, 0.20, 0.15, 0.18,
                                     0.11, 0.07, 0.06, 0.01, 0.01))
fatyield.dat$week=1:35
attach(fatyield.dat)
lweek<-log(week)
plot(fatyield.dat$week,fatyield.dat$yield, pch="*", xlab="Weeks", ylab="Fat yield (kg/day)",
     main="Figura 1. Observed fat yield (kg/day) for each week")


################################################################################
#Analise Exploratoria dos dados
dados_longos = tidyr::pivot_longer(fatyield.dat, cols = c(yield, week), names_to = "Variavel", values_to = "Valor")

estatisticas_descritivas = dados_longos %>%
  group_by(Variavel) %>%
  summarise(Media = mean(Valor),
            Mediana = median(Valor),
            Desvio_Padrao = sd(Valor),
            `IQR` = IQR(Valor),
            Curtose = kurtosis(Valor),
            Simetria = skewness(Valor),
            Minimo = min(Valor),
            Maximo = max(Valor),
            outliers_inferiores = sum(Valor < quantile(Valor, 0.25) - 1.5 * IQR(Valor)),
            outliers_superiores = sum(Valor > quantile(Valor, 0.75) + 1.5 * IQR(Valor))); estatisticas_descritivas

corrplot(cor(fatyield.dat), method = "number")

#teste de normalidade
dados_longos %>%
  group_by(Variavel) %>%
  summarise(valor_p = shapiro.test(Valor)$p.value)

ggplot(dados_longos, aes(x = Valor)) +
  geom_histogram(color = "black", fill = "lightblue") +
  facet_wrap(~ Variavel, scales = "free") +
  labs(x = "Valores", y = "Frequencias", title = "Histogramas das Variaveis") +
  theme_minimal()

ggplot(dados_longos, aes(x = Variavel, y = Valor)) +
  geom_boxplot() +
  facet_wrap(~ Variavel, scales = "free") +
  labs(x = "Valores", y = "Frequencias", title = "Boxplots das Variaveis") +
  theme_minimal()

ggplot(dados_longos, aes(x = Variavel, color = Variavel)) +
  geom_density() +
  labs(y = "Densidade", title = "Grafico de Densidade das Variaveis") +
  theme_minimal() +
  theme(axis.text.x = element_blank())
```

  As estatísticas descritivas da variável week (semanas) apontam que a média e a mediana são as mesmas, o que é bem óbvio pois foi fixado o período 35 semanas para o estudo em questão. Então não faz muito sentido analisar as estatísticas descritivas dessa variável.
  Já a variável Yield (rendimento) apresenta uma média de 0.40 kg/dia e um desvio padrão de 0.22. A mediana é 0.36, sugerindo uma distribuição assimétrica positiva. A curtose de 1.85 indica uma distribuição leptocúrtica, enquanto que a simetria negativa de -0.14 sugere uma cauda esquerda mais longa. O rendimento varia de 0.01 a 0.72 kg/dia. Não há outliers.
  Foi feito o teste shapiro-wilk de normalidade e a variável rendimento rejeitou a hipótese de normalidade à um nível de significância de 5%.
  As variáveis semanas e rendimento apresentam uma forte correlação negativa de -0.82, ou seja, a tendência do rendimento é diminuir com o decorrer das semanas.


```{r Exercicio 6.2.2, echo=T, message=FALSE, warning=FALSE}

## Normal model for log(fat)
lyield<-log(yield)
mod1<-lm(lyield~week+lweek)
summary(mod1)
fit1<-fitted(mod1)

## Normal model with log link
mod2<-glm(yield~week+lweek, (family=gaussian(link="log")))
fit2<-fitted(mod2)

# Plotting
plot(c(0,35), c(0,0.9), type="n", xlab="Weeks", ylab="Fat yield (kg/day)")
points(week,yield, pch="*")
w<-seq(1,35,0.1)
lines(w, predict(mod2,data.frame(week=w, lweek=log(w)),type="response"),
      col="green", lty=1)
lines(w, exp(predict(mod1,data.frame(week=w, lweek=log(w)),type="response")),
      col="red", lty=2)
legend(20,0.9,c("Observed","Log transformation", "Log link"), lty=c(-1,2,1),
       pch=c("*"," "," "), col=c("black","red","green"),cex=.6)
title(sub="Figura 1. Fat yield (kg/day) for each week")

```

  Aqui, foram usados dois modelos. Um onde usa-se a distribuição normal com função de ligação identitado, onde os dados foram transformados para a escala logaritmica. Outro modelo usa a dustribuição normal com função de ligação logaritmica, sem transformar os dados. A anova do primeiro modelo nos diz que a variável semanas é significativa para a produção/rendimento e o R-quadrado ajustado sugere que 76.83% da variabilidade na variável resposta é explicada pelo modelo. Entretanto, o gráfico nos diz que a distribuição normal com função de ligação logaritmica é melhor do que o primeiro modelo, mas a análise de resíduos e diagnóticos se fazem necessárias para tirar qualquer conclusão.


6.3 Dados de importacão Brasileira 
Os dados da Tabela 6.4 referem-se a importações brasileiras (IM) em milhões de dólares, taxa de câmbio (TCI) e o Produto Interno Bruto representando a renda nacional (RN). Os dados são trimestrais das contas externas do Brasil no período de 1980 a 1998 (Banco Central). A taxa de câmbio representa a relação entre reais e dólar, isto é, quantos reais são gastos para comprar um dólar americano e, por fim, a renda nacional em número índice (dez90 = 100).


```{r Exercicio 6.3.1, echo=T, message=FALSE, warning=FALSE}
rm(list=ls())
library(readxl)
library(tidyverse)
library(tidyr)
library(moments)
library(MASS)
library(car)
library(corrplot)


importa.dat <- data.frame(matrix(
c(5482, 1.629, 82.17,
4046, 1.423, 109.40,
5749, 1.517, 88.80,
5495, 1.356, 111.36,
6043, 1.331, 87.94,
5173, 1.244, 105.50,
5679, 1.181, 85.28,
4576, 1.046, 97.60,
5605, 1.315, 82.06,
4265, 1.091, 96.39,
5565, 1.217, 86.49,
5474, 1.091, 106.01,
5610, 1.177, 82.62,
6345, 1.300, 100.01,
5309, 1.135, 78.30,
4330, 1.380, 91.70,
4804, 1.434, 78.34,
5034, 1.354, 104.02,
4872, 1.306, 87.11,
5614, 1.314, 108.26,
5071, 1.209, 85.77,
6015, 1.452, 101.05,
4646, 1.156, 80.91,
4630, 1.499, 97.02,
3824, 1.740, 75.88,
4725, 1.626, 101.71,
3651, 2.004, 83.65,
5221, 1.467, 103.80,
3907, 1.957, 82.80,
5976, 1.441, 101.30,
4044, 1.959, 80.10,
5230, 1.421, 99.90,
3155, 1.971, 79.10,
6007, 1.388, 106.90,
3406, 2.015, 87.59,
7328, 1.340, 108.92,
3730, 2.024, 87.19,
6914, 1.305, 106.01,
3623, 2.027, 85.94,
6049, 1.283, 104.01,
3094, 2.036, 84.55,
7087, 1.279, 109.66,
3016, 2.219, 92.47,
8023, 1.075, 115.30,
3132, 2.201, 95.23,
11814, 0.957, 116.45,
3925, 2.131, 94.44,
12065, 0.942, 113.92,
3352, 2.013, 90.69,
13651, 0.955, 116.09,
2760, 2.023, 99.48,
11917, 0.951, 115.67,
3661, 1.991, 102.87,
12030, 0.970, 114.93,
4270, 1.924, 101.15,
10738, 0.980, 111.63,
3565, 1.832, 97.65,
12478, 0.995, 118.06,
3610, 1.792, 106.21,
14235, 1.012, 122.90,
3987, 1.914, 103.45,
15837, 1.030, 120.69,
3888, 1.789, 101.10,
13150, 1.049, 116.90,
3516, 1.692, 97.72,
15405, 1.067, 123.85,
3349, 1.657, 105.78,
16930, 1.086, 126.37,
3776, 1.643, 105.84,
15873, 1.106, 122.55,
3963, 1.607, 98.87,
13415, 1.126, 118.11,
3548, 1.557, 95.01,
14591, 1.147, 125.74), 74, 3, byrow = TRUE))

IM <- importa.dat[,1]
TCI <- importa.dat[,2]
RN <- importa.dat[,3]
invIM <- 1/IM
logIM <- log(IM)
importa.dat <-data.frame(IM,TCI,RN)


################################################################################
#Analise Exploratoria dos dados
dados_longos = tidyr::pivot_longer(importa.dat, cols = c(TCI, RN), names_to = "Variavel", values_to = "Valor")

estatisticas_descritivas = dados_longos %>%
  group_by(Variavel) %>%
  summarise(Media = mean(Valor),
            Mediana = median(Valor),
            Desvio_Padrao = sd(Valor),
            `IQR` = IQR(Valor),
            Curtose = kurtosis(Valor),
            Simetria = skewness(Valor),
            Minimo = min(Valor),
            Maximo = max(Valor),
            outliers_inferiores = sum(Valor < quantile(Valor, 0.25) - 1.5 * IQR(Valor)),
            outliers_superiores = sum(Valor > quantile(Valor, 0.75) + 1.5 * IQR(Valor))); estatisticas_descritivas

corrplot(cor(importa.dat), method = "number")

#teste de normalidade
dados_longos %>%
  group_by(Variavel) %>%
  summarise(valor_p = shapiro.test(Valor)$p.value)

ggplot(dados_longos, aes(x = Valor)) +
  geom_histogram(color = "black", fill = "lightblue") +
  facet_wrap(~ Variavel, scales = "free") +
  labs(x = "Valores", y = "Frequencias", title = "Histogramas das Variaveis") +
  theme_minimal()

ggplot(dados_longos, aes(x = Variavel, y = Valor)) +
  geom_boxplot() +
  facet_wrap(~ Variavel, scales = "free") +
  labs(x = "Valores", y = "Frequencias", title = "Boxplots das Variaveis") +
  theme_minimal()

ggplot(dados_longos, aes(x = Variavel, color = Variavel)) +
  geom_density() +
  labs(y = "Densidade", title = "Grafico de Densidade das Variaveis") +
  theme_minimal() +
  theme(axis.text.x = element_blank())

```

  Analisando as estatísticas descritivas  da renda nacional (RN), a média é de 100.14 milhões de dólares, enquanto que o desvio padrão é de 13.36, o que representa uma baixa dispersão. A mediana é 101.08, indicando uma distribuição praticamente simétrica. O intervalo interquartil de 21.60 sugere uma variação significativa na renda nacional. A curtose negativa sugere que a distribuição é plana, enquanto que a simetria próxima à zero sugere uma distribuição quase simétrica. A renda nacional varia de 75.88 a 126.37 milhões de dólares. Não há presença de outliers.
  Já a média da taxa de câmbio (TCI) é de 1.46 e o desvio padrão de 0.37 indica uma variação moderada em relação à média. A mediana é menor que a média, sugerindo uma distribuição assimétrica positiva. O intervalo interquartil de 0.64 sugere uma variação média na taxa de câmbio. A curtose negativa indica que a distribuição é mais achatada e a simetria positiva de 0.44 sugere uma cauda direita mais longa. A taxa de câmbio varia de 0.94 a 2.22 milhões de dólares. Não há presença de outliers.
  Foi realizado o teste shapiro-wilk de normalidade e a variável da taxa de câmbio rejeitou a hipótese de normalidade à um nível de significância de 5%.
  As variáveis da renda nacional (RN) e da taxa de câmbio (TCI) apresentam uma correlação negativa moderada de -0.52, ou seja, a tendência da renda nacional é diminuir com caso da taxa de câmbio aumente.



```{r Exercicio 6.3.2, echo=T, message=FALSE, warning=FALSE}
importa.dat <-data.frame(IM,logIM,invIM,TCI,RN)

# IM Normal como fun¸c~ao de liga¸c~ao identidade
importa.Nident<-glm(formula = IM ~ TCI + RN, family = gaussian(identity),data = importa.dat)
anova(importa.Nident, test="F")
summary(importa.Nident)
plot(fitted(importa.Nident),IM, xlab="valor ajustado", ylab="valor observado", main="Normal(identidade)")
plot(fitted(importa.Nident), rstudent(importa.Nident), xlab="valor ajustado", ylab="valor observado", 
            main="Normal(identidade)")
plot(TCI, rstudent(importa.Nident), xlab="TCI", ylab="residuos",
     main="Normal(identidade)")
plot(RN, rstudent(importa.Nident), xlab="RN", ylab="residuos",
     main="Normal(identidade)")
qqnorm(resid(importa.Nident),ylab="Residuo",main="Normal(identidade)")


```

Foi justado o modelo normal com função de ligação identidade. Os gráficos evidenciam uma falta de ajuste entre o modelo e os dados. A análise do gráfico de valor ajustado versus valor observado revela a ausência de linearidade, enquanto os gráficos dos resíduos das variáveis RN e TCI indicam violações das suposições de homocedasticidade e independência. Isso se deve à não aleatoriedade na distribuição dos pontos. Além disso, a análise do gráfico de quantis destaca que a suposição de normalidade dos resíduos não é atendida.

```{r Exercicio 6.3.3, echo=T, message=FALSE, warning=FALSE}
# log(IM) Normal como funcao de ligacao identidade
importa.logNident<-glm(formula = logIM ~ TCI + RN, family = gaussian(identity),
                       data = importa.dat)
anova(importa.logNident, test="F")
summary(importa.logNident)
plot(fitted(importa.logNident),logIM, xlab="valor ajustado", ylab="valor observado",
     main="logNormal(identidade)")
plot(fitted(importa.logNident), rstudent(importa.logNident), xlab="valor ajustado",
     main="logNormal(identidade)")
plot(TCI, rstudent(importa.logNident), xlab="TCI", ylab="residuos",
     main="logNormal(identidade)")
plot(RN, rstudent(importa.logNident), xlab="RN", ylab="residuos",
     main="logNormal(identidade)")
qqnorm(resid(importa.logNident),ylab="Residuo",main="logNormal(identidade)")
qqline(resid(importa.logNident))
```

  Aqui, também foi ajustado um modelo normal com função de ligação identidade, porém a variável resposta IM foi transformada para a escala logarítmica. Mesmo com a transformação, ainda há falta de ajuste do modelo.


```{r Exercicio 6.3.4, echo=T, message=FALSE, warning=FALSE}
# IM Normal como funcao de ligacao logarıtmica
importa.Nlog<-glm(formula = IM ~ TCI + RN, family = gaussian(log),data = importa.dat)
anova(importa.Nlog, test="F")
summary(importa.Nlog)
plot(fitted(importa.Nlog),IM, xlab="valor ajustado", ylab="valor observado",
     main="Normal(log)")
plot(fitted(importa.Nlog), rstudent(importa.Nident), xlab="valor ajustado", ylab="restudentizado",
            main="Normal(log)")
plot(TCI, rstudent(importa.Nlog), xlab="TCI", ylab="residuos",
     main="Normal(log)")
plot(RN, rstudent(importa.Nlog), xlab="RN", ylab="residuos",
     main="Normal(log)")
qqnorm(resid(importa.Nlog),ylab="Residuo",main="Normal(log)")
qqline(resid(importa.Nlog))
```

  Agora, foi ajustado o modelo normal com função de ligação logarítmica, porém a variável resposta voltou para a escala original. Os gráficos confirmam a falta de ajuste do modelo apresentando os mesmos problemas que os anteriores.


```{r Exercicio 6.3.5, echo=T, message=FALSE, warning=FALSE}
# IM Gama como funcao de ligacao inversa
importa.Ginv<-glm(formula = IM ~ TCI + RN, family = Gamma(inverse),data = importa.dat)
anova(importa.Ginv, test="F")
summary(importa.Ginv)
plot(fitted(importa.Ginv),IM, xlab="valor ajustado", ylab="valor observado",
      main="Gamma(inversa)")
plot(fitted(importa.Ginv), importa.Ginv$deviance.resid, xlab="valor ajustado",
     ylab="resıduos", main="Gamma(inversa)")
plot(TCI, importa.Ginv$deviance.resid, xlab="TCI", ylab="residuos",
     main="Gamma(inversa)")
plot(RN, importa.Ginv$deviance.resid, xlab="RN", ylab="residuos",
     main="Gamma(inversa)")
qqnorm(resid(importa.Ginv),ylab="Residuo",main="Gamma(inversa)")
qqline(resid(importa.Ginv))
```

  Agora foi usado o modelo gama com função de ligação canônica. Nesse caso, as variáveis TCI e RN são significativas e as suposições de independência e homocedasticidade são atendidas, como mostram os gráficos do valor ajustado, dos resíduos e dos quantis.


```{r Exercicio 6.3.6, echo=T, message=FALSE, warning=FALSE}
# IM Gama como funcao de ligacao identidade
importa.Gident<-glm(formula = IM ~ TCI + RN, family = Gamma(identity),data = importa.dat)
anova(importa.Gident, test="F")
summary(importa.Gident)
plot(fitted(importa.Gident),IM, xlab="valor ajustado", ylab="valor observado",
     main="Gamma(identity)")
plot(fitted(importa.Gident), importa.Ginv$deviance.resid, xlab="valor ajustado", ylab = "residuos",
      main="Gamma(identity)")
plot(TCI, importa.Gident$deviance.resid, xlab="TCI", ylab="residuos",
     main="Gamma(identity)")
plot(RN, importa.Gident$deviance.resid, xlab="RN", ylab="residuos",
     main="Gamma(identity)")
qqnorm(resid(importa.Gident),ylab="Residuo",main="Gamma(identity)")
qqline(resid(importa.Gident))
```

  Aqui foi usado o modelo gama com função de ligação identidade. As variáveis RN e TCI são significativas e as suposições de homocedasticidade e independência também são atendidas.  



```{r Exercicio 6.3.7, echo=T, message=FALSE, warning=FALSE}                  
# IM Gama como funcao de ligacao logarıtmica
importa.Glog<-glm(formula = IM ~ TCI + RN, family = Gamma(log),data = importa.dat)
anova(importa.Glog, test="F")
summary(importa.Glog)
plot(fitted(importa.Glog),IM, xlab="valor ajustado", ylab="valor observado",
     main="Gamma(log)")
plot(fitted(importa.Glog), importa.Ginv$deviance.resid, xlab="valor ajustado", ylab="Gamma(log)")
plot(TCI, importa.Glog$deviance.resid, xlab="TCI", ylab="resıduos",
     main="Gamma(log)")
plot(RN, importa.Glog$deviance.resid, xlab="RN", ylab="residuos",
     main="Gamma(log)")
qqnorm(resid(importa.Glog),ylab="Residuo",main="Gamma(log)")
qqline(resid(importa.Glog))                    

```

  Por fim, foi usado um modelo gama com função de ligação logaritmica. As variáveis RN e TCI são significativas e as suposições do modelo também foram atendidas.
  Ao contrário do modelo normal, o modelo gama com função de ligação inversa, identidade e logaritmica são os modelos adequados para esses dados. Utilizando o AIC como critério de seleção, o modelo gama com função de ligação inversa (canônica) é o que apresenta menor AIC.



6.5 Dados de assinaturas de TV a cabo
Os dados da Tabela 6.9 referem-se a número de assinantes(em milhares) de TV a Cabo Y em 40 areas metropolitanas (Ramanathan, 1993), numero de domicilios (em milhares) na area (x1), renda per capita (em US$) por domicilio com TV a cabo (x2), taxa de instalacao (x3), custo medio mensal de manutencao (x4), numero de canais a cabo disponiveis na area (x5) e numero de canais nao pagos com sinal de boa qualidade disponiveis na area (x6). O interesse esta em modelar o numero de assinantes (variavel resposta) como funcao das demais variaveis (variaveis explanatorias).


```{r Exercicio 6.5.1, echo=T, message=FALSE, warning=FALSE}
rm(list=ls())
library(readxl)
library(tidyverse)
library(tidyr)
library(moments)
library(MASS)
library(car)
library(corrplot)
library(EnvStats)

dados <- data.frame(matrix(
c(105.000, 350.000, 9839, 14.95, 10.00, 16, 13,
90.000, 255.631, 10606, 15.00, 7.50, 15, 11, 
14.000, 31.000, 10455, 15.00, 7.00, 11, 9,
11.700, 34.840, 8958, 10.00, 7.00, 22, 10, 
46.000, 153.434, 11741, 25.00, 10.00, 20, 12,
11.217, 26.621, 9378, 15.00, 7.66, 18, 8, 
12.000, 18.000, 10433, 15.00, 7.50, 12, 8,
6.428, 9.324, 10167, 15.00, 7.00, 17, 7, 
20.100, 32.000, 9218, 10.00, 5.60, 10, 8,
8.500, 28.000, 10519, 15.00, 6.50, 6, 6, 
1.600, 8.000, 10025, 17.50, 7.50, 8, 6, 
1.100, 5.000, 9714, 15.00, 8.95, 9, 9,
4.355, 15.204, 9294, 10.00, 7.00, 7, 7, 
78.910, 97.889, 9784, 24.95, 9.49, 12, 7, 
19.600, 93.000, 8173, 20.00, 7.50, 9, 7,
1.000, 3.000, 8967, 9.95, 10.00, 13, 6, 
1.650, 2.600, 10133, 25.00, 7.55, 6, 5, 
13.400, 18.284, 9361, 15.50, 6.30, 11, 5,
18.708, 55.000, 9085, 15.00, 7.00, 16, 6, 
1.352, 1.700, 10067, 20.00, 5.60, 6, 6,
170.000, 270.000, 8908, 15.00, 8.75, 15, 5,
15.388, 46.540, 9632, 15.00, 8.73, 9, 6, 
6.555, 20.417, 8995, 5.95, 5.95, 10, 6, 
40.000, 120.000, 7787, 25.00, 6.50, 10, 5,
19.900, 46.390, 8890, 15.00, 7.50, 9, 7, 
2.450, 14.500, 8041, 9.95, 6.25, 6, 4, 
3.762, 9.500, 8605, 20.00, 6.50, 6, 5,
24.882, 81.980, 8639, 18.00, 7.50, 8, 4, 
21.187, 39.700, 8781, 20.00, 6.00, 9, 4, 
3.487, 4.113, 8551, 10.00, 6.85, 11, 4,
3.000, 8.000, 9306, 10.00, 7.95, 9, 6, 
42.100, 99.750, 8346, 9.95, 5.73, 8, 5, 
20.350, 33.379, 8803, 15.00, 7.50, 8, 4,
23.150, 35.500, 8942, 17.50, 6.50, 8, 5, 
9.866, 34.775, 8591, 15.00, 8.25, 11, 4, 
42.608, 64.840, 9163, 10.00, 6.00, 11, 6,
10.371, 30.556, 7683, 20.00, 7.50, 8, 6, 
5.164, 16.500, 7924, 14.95, 6.95, 8, 5,
31.150, 70.515, 8454, 9.95, 7.00, 10, 4, 
18.350, 42.040, 8429, 20.00, 7.00, 6, 4),280, 7, byrow = TRUE))
colnames(dados) = c("Y", "x1", "x2", "x3", "x4", "x5", "x6")

################################################################################
#Analise Exploratoria dos dados
dados_longos = tidyr::pivot_longer(dados, cols = c(Y, x1, x2, x3, x4, x5, x6), 
                                   names_to = "Variavel", values_to = "Valor")

estatisticas_descritivas = dados_longos %>%
  group_by(Variavel) %>%
  summarise(Media = mean(Valor),
            Mediana = median(Valor),
            Desvio_Padrao = sd(Valor),
            `IQR` = IQR(Valor),
            Curtose = kurtosis(Valor),
            Simetria = skewness(Valor),
            Minimo = min(Valor),
            Maximo = max(Valor),
            outliers_inferiores = sum(Valor < quantile(Valor, 0.25) - 1.5 * IQR(Valor)),
            outliers_superiores = sum(Valor > quantile(Valor, 0.75) + 1.5 * IQR(Valor))); estatisticas_descritivas

corrplot(cor(dados), method = "number")

#teste de normalidade
dados_longos %>%
  group_by(Variavel) %>%
  summarise(valor_p = shapiro.test(Valor)$p.value)

ggplot(dados_longos, aes(x = Valor)) +
  geom_histogram(color = "black", fill = "lightblue") +
  facet_wrap(~ Variavel, scales = "free") +
  labs(x = "Valores", y = "Frequencias", title = "Histogramas das Variaveis") +
  theme_minimal()

ggplot(dados_longos, aes(x = Variavel, y = Valor)) +
  geom_boxplot() +
  facet_wrap(~ Variavel, scales = "free") +
  labs(x = "Valores", y = "Frequencias", title = "Boxplots das Variaveis") +
  theme_minimal()

ggplot(dados_longos, aes(x = Variavel, color = Variavel)) +
  geom_density() +
  labs(y = "Densidade", title = "Grafico de Densidade das Variaveis") +
  theme_minimal() +
  theme(axis.text.x = element_blank())
```

  Com relação as estatísticas descritivas, podemos afirmar que a média de assinantes (Y) é 24.51, com uma mediana de 13.70, o que indica uma possível distribuição assimétrica positiva. O desvio padrão de 33.17 e o intervalo interquartil de 18,62 apontam uma alta variabilidade dos dados. A curtose elevada de 7.99 sugere que a distribuição seja leptocúrtica e a simetria de 2.71 confirma a assimetria positiva. O número de assinaturas varia de 1 a 170. Existem 28 outliers superiores nessa variável.
  A média do número de domicílios (x1) é de 58.19 e a mediana é menor que a média, indicando uma distribuição assimétrica positiva. O desvio padrão de 75.86 e o intervalo interquartil de 51.23 indicam uma alta variabilidade dos dados. A curtose alta indica uma distribuição leptocúrtica e a simetria positiva de 2.40 sugere que a cauda da direita seja mais longa. O número de domicílios varia de 1.7 a 350 milhares. Há cerca de 28 outliers superiores nessa variável.
  A renda per capita (x2) tem uma média de 9209.68 dólares, com uma mediana de 9040.00 dólares. O desvio padrão e o intervalo interquartil indicam uma baixa variabilidade dos dados. A curtose próxima a zero sugere uma distribuição aproximadamente normal, enquanto a simetria positiva indica uma cauda direita mais longa. A curtose próxima a zero sugere uma distribuição mesocurtica, enquanto a simetria positiva indica uma cauda direita mais longa. a renda per cápita varia de 7683 a 11741	dolares. Há presença de 7 outliers superiores nessa variável.
  A taxa de instalação (x3) possui uma média de 15.48, com uma mediana de 15, o que indica uma leva assimetria positiva. o desvio padrão e o intervalo interquartil de 4.74 8.50, respectivamente, indicam que a variabilidade dos dados é moderada. A curtose negativa sugere que a distribuição é platicurtica, enquanto que a simetria próxima a zero indica uma distribuição quase simétrica. a taxa de instalação varia de 5.95 a 25. Não há presença de outliers.
  O custo médio mensal de manutenção tem uma média de 7.34 e uma mediana de 7, o que indica uma leve assimetria positiva. O desvio padrão e o intervalo interquartil de 1.17 e 1.08, respectivamente, apontam uma variabilidade moderada dos dados. A curtose próxima a zero sugere uma distribuição mesocurtica e a simetria positiva indicando uma cauda direita mais longa.
  O número médio de canais a cabo disponíveis (x5) é de 10.60 com uma mediana de 9.50, o que sugere que a distribuição apresenta assimetria positiva. O desvio padrão e o intervalo interquartil de 3.96 e 4.00, respectivamente, apontam que os dados apresentam uma variabilidade moderada. A distribuição tem uma curtose positiva, indicando caudas mais pesadas.
  O número médio de canais não pagos (x6) é 6.38, com uma mediana de 6.00. o desvio padrão e o intervalo interquartil de 2.21 e 2.00, respectivamente, apontam uma alta variabilidade dos dados. A curtose positiva sugere caudas mais pesadas na distribuição, e a simetria positiva indica que a distribuição seja assimétrica à direita. o número de canais varia de 4.00	a 13.
  Foi realizado o teste shapiro-wilk de normalidade e todas as variáveis rejeitaram a hipótese de normalidade à um nível de significância de 5%.
  

```{r Exercicio 6.5.2, echo=T, message=FALSE, warning=FALSE}

################################################################################
glm(formula=Y~x1+x2+x3+x4+x5+ x6, 
    family= gaussian(identity),data=dados)
glm(formula=Y~x1+x2+x3+x4+x5+ x6, 
    family= gaussian(log),data=dados)

glm(formula=Y~x1+x2+x3+x4+x5+ x6, 
    family= Gamma(identity),data=dados)
glm(formula=Y~x1+x2+x3+x4+x5+ x6,
    family= Gamma(log),data=dados)


```

  Todos os modelos são aceitos por possuirem o desvio inferior ao ponto crítico da qui-quadrado com 33 graus de liberdade. Utilizando como base apenas o critético AIC podemos afirmar que os dois modelos gama são melhores do que os dois modelos normais. Agora, analisando o modelo gama com ligação identidade e o modelo gama com função de ligação logaritmica, iremos escolher o modelo gama com função de ligação identidade por ter um desvio de 30.2, que é inferior ao desvio de 129.8 do modelo gama com função de ligação logaritmica.




6.6 Dados de demanda de energia elétrica 
O segundo modelo tem como variável resposta a demanda de eletricidade agregada per capita para o setor residencial (ELAR), e como variaveis explicativas o preco medio da eletricidade para o setor residencial (PER), o preco do gas natural para o setor residencial (PGR) e a renda per capita (RECA). Ainda, D1, D2, D3 e D4 sao variaveis binarias e foram incluidas no modelo pois os dados sao trimestrais. T representa o trimestre e os dados foram coletados no primeiro trimestre de 1961 até o quarto trimestre de 1983, com o total de 92 observacoes. Abaixo estao apresentados o numero de observacoes e todas as variaveis do modelo.


```{r Exercicio 6.6.1, echo=T, message=FALSE, warning=FALSE}
rm(list=ls())
library(readxl)
library(tidyverse)
library(tidyr)
library(moments)
library(MASS)
library(car)
library(corrplot)
library(EnvStats)

dados <- read.table("C:/Users/leona/Desktop/Atividade de Multivariada/dados - Demanda de energia.txt", header=FALSE)
colnames(dados) = c("ANO", "T", "ELAR", "PER", "PGR", "RECA", "D1", "D2", "D3", "D4")
ano<-dados[,1] 
t<-dados[,2] 
elar<-dados[,3] 
per<-dados[,4]
pgr<-dados[,5] 
reca<-dados[,6] 
D1<-dados[,7] 
D2<-dados[,8]
D3<-dados[,9] 
D4<-dados[,10] 
DD1<-factor(D1) 
DD2<-factor(D2)
DD3<-factor(D3) 
DD4<-factor(D4)
################################################################################
#Analise Exploratoria dos dados
dados_longos = tidyr::pivot_longer(dados, cols = c(ELAR, PER, PGR, RECA), 
                                   names_to = "Variavel", values_to = "Valor")

estatisticas_descritivas = dados_longos %>%
  group_by(Variavel) %>%
  summarise(Media = mean(Valor),
            Mediana = median(Valor),
            Desvio_Padrao = sd(Valor),
            `IQR` = IQR(Valor),
            Curtose = kurtosis(Valor),
            Simetria = skewness(Valor),
            Minimo = min(Valor),
            Maximo = max(Valor),
            outliers_inferiores = sum(Valor < quantile(Valor, 0.25) - 1.5 * IQR(Valor)),
            outliers_superiores = sum(Valor > quantile(Valor, 0.75) + 1.5 * IQR(Valor))); estatisticas_descritivas

corrplot(cor(dados), method = "number")

#teste de normalidade
dados_longos %>%
  group_by(Variavel) %>%
  summarise(valor_p = shapiro.test(Valor)$p.value)

ggplot(dados_longos, aes(x = Valor)) +
  geom_histogram(color = "black", fill = "lightblue") +
  facet_wrap(~ Variavel, scales = "free") +
  labs(x = "Valores", y = "Frequencias", title = "Histogramas das Variaveis") +
  theme_minimal()

ggplot(dados_longos, aes(x = Variavel, y = Valor)) +
  geom_boxplot() +
  facet_wrap(~ Variavel, scales = "free") +
  labs(x = "Valores", y = "Frequencias", title = "Boxplots das Variaveis") +
  theme_minimal()

ggplot(dados_longos, aes(x = Variavel, color = Variavel)) +
  geom_density() +
  labs(y = "Densidade", title = "Grafico de Densidade das Variaveis") +
  theme_minimal() +
  theme(axis.text.x = element_blank())
```
  As estatísticas descritivas da demanda de eletricidade per capita (ELAR) mostram que a média é de é 0.58, com uma mediana de 0.61, o que indica uma assimetria negativa. O desvio padrão de 0.19 e intervalo interquantil de 0.31 indicam que essa variável tem uma grande variabilidade. O valor negativo da curtose confirma a que distribuição é platicurtica, enquanto que o valor negativo da simetria confirma que a distribuição é assimétrica a esquerda.
  O preço médio da eletricidade (PER) tem uma média de 5.96, com uma mediana de 5.74. Os valores muito próximos indicam que a distribuição é simétrica. O desvio padrão e o intervalo interquartil apresentam valores de 0.949 e 1.26, respectivamente, que apontam uma baixa variabilidade dos dados. A curtose próxima a zero sugere uma distribuição aproximadamente mesocurtica, assim como a simetria próximo a zero indica que a distribuição seja simétrica.
  O preço do gás natural (PGR) possui uma média de 3.45 e uma mediana de 3.14, o que indica que a distribuição seja levemente assimétrica à direita. o desvio padrão e intervalo interquartil de 0.94 e 1.26, respectivamente, apontam a moderada variabilidade dos dados. A curtose positiva indica caudas mais pesadas na distribuição.
  A renda per capita (RECA) tem uma média de 0.01 e uma mediana de 0.01, indicando que a distribuição possa ser simétrica. O desvio padrão e interalo interquartil de 0.0015 e 0.002, respectivamente, indicam uma baixa variabilidade dos dados.


```{r Exercicio 6.6.2, echo=T, message=FALSE, warning=FALSE}
############# Modelo Normal com funcao de ligacao identidade
fit1<-glm(elar~per+pgr+reca+DD1+DD2+DD3,
          family = gaussian(link = "identity"))
summary(fit1)
############# Modelo Normal com funcao de ligacao log
fit2<-glm(elar~per+pgr+reca+DD1+DD2+DD3,
          family = gaussian(link = "log"))
summary(fit2)
plot(elar,fit2$fitted, ylab="Valores ajustados",
     xlab="Valores observados",
     main="Valores ajustados X valores observados.")
############# calculo do resıduo de Anscomb 
ra<-(elar-fit2$fitted) 
ra<-sort(ra) 
qqnorm(ra)
############# calculo do res´ıduo de pearson 
rp<-(elar-fit2$fitted)
plot(fit2$fitted,rp, ylab="Res´ıduos de Pearson",
     xlab="Valores ajustados",
     main="Res´ıduos de Pearson X valores ajustados")

```

  Foram usados dois modelos:o modelo normal com função de ligação identidade e outro com função de ligação logaritmica. O modelo que melhor se ajusta aos dados é o modelo com função de ligação logaritmica, pois seu desvio é de 0.17, inferior ao desvio de 0.21 do modelo normal com função de ligação identidade. Além disso, o seu AIC também é inferior. Ao nível de significância de 5%, todas as variáveis foram significativas no modelo normal com função de ligação logaritmica.
  Agora vamos analisar o gráfico do modelo normal com função de ligação logaritimica. Olhando o gráfico dos valores observados e ajustados, podemos observar que é razoável o ajuste do modelo linear visto que tem uma tendência linear. Olhando o gráfico dos resíduos de Pearson vs Valores ajustados, podemos ver que os resíduos apresenta uma distribuição aleatória, indicando que os resíduos são não correlacionados. Dessa forma, podemos dizer que a hipótese de independÊncia e variância para os resíduos são aceitas. Observando o gráfico QQ-Plot entre os quantis amostrais e teóricos, podemos dizer que a hipótese de normalidade é aceita.
